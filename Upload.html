<!doctype html>
<html>
  <head>
    <base target="_top" />
    <style>
      body { font-family: sans-serif; padding: 16px; }
      button { padding: 6px 12px; cursor: pointer; }
      pre { white-space: pre-wrap; background: #f6f6f6; padding: 12px; border-radius: 6px; }
    </style>
  </head>

  <body>
    <h3>画像アップロード</h3>
    <input type="file" id="fileInput" accept="image/*" />
    <button onclick="submit()">送信</button>

    <pre id="status"></pre>

    <script>
      function submit() {
        const fileInput = document.getElementById("fileInput");
        const status = document.getElementById("status");
        const file = fileInput.files[0];

        if (!file) {
          alert("画像を選択してください");
          return;
        }

        status.textContent = "処理中…";

        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            // 画像をリサイズ（最大 1024px）
            const MAX_SIZE = 1024;
            let width = img.width;
            let height = img.height;

            if (width > height && width > MAX_SIZE) {
              height = (height * MAX_SIZE) / width;
              width = MAX_SIZE;
            } else if (height > MAX_SIZE) {
              width = (width * MAX_SIZE) / height;
              height = MAX_SIZE;
            }

            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            // JPEG圧縮してbase64だけ取り出す
            const base64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];

            google.script.run
              .withSuccessHandler((res) => {
                // resがオブジェクトならJSON文字列に
                const text =
                  typeof res === "string" ? res : JSON.stringify(res, null, 2);
                status.textContent = "完了:\n" + text;
              })
              .withFailureHandler((err) => {
                const msg =
                  err && err.message ? err.message : JSON.stringify(err);
                status.textContent = "エラー:\n" + msg;
              })
              .processImage(base64);
          };

          img.src = e.target.result;
        };

        reader.readAsDataURL(file);
      }
    </script>
  </body>
</html>
